name: Update contributors in README(s)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Select branch to update"
        type: choice
        required: true
        options:
          - master
          - 2.0-dev
        default: master

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0
          persist-credentials: true
          
      - name: Sanity check for token
        env:
          GITHUB_TOKEN: ${{ secrets.MY_GH_PAT }}
        run: |
          if [ -z "${GITHUB_TOKEN}" ]; then
            echo "::error::GITHUB_TOKEN is empty. Check: Settings → Actions → General → Workflow permissions = Read and write. Also ensure this workflow file is on the default branch."
            exit 1
          fi
          echo "OK: GITHUB_TOKEN present."
          
      # 2) 自检：分支 & 文件是否存在
      - name: Check branch and README paths
        run: |
          echo "Current branch = ${{ github.event.inputs.branch }}"
          git rev-parse --verify "origin/${{ github.event.inputs.branch }}" || { echo "::error::Branch not found on remote"; exit 1; }
          ls -la || true
          for f in README.md README_zh.md; do
            if [ ! -f "$f" ]; then
              echo "::error::File not found on this branch: $f"
              exit 1
            fi
          done
          echo "OK: README files exist."

      # 3) 冒烟：分支保护接口（很多 404 出在这里）
      - name: Probe branch protection API (status only)
        env:
          GITHUB_TOKEN: ${{ secrets.MY_GH_PAT }}
        run: |
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          BRANCH="${{ github.event.inputs.branch }}"
          # 仅打印 HTTP 状态码，避免输出敏感信息
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$OWNER/$REPO/branches/$BRANCH/protection)
          echo "Branch protection HTTP status = $STATUS"
          # 404 在这里通常表示：没开保护或权限不足，属正常情况；我们后面会关闭自动探测，直接跳过

      # 4) 冒烟：contributors 接口（确认仓库/权限是否可访问）
      - name: Probe contributors endpoint (status only)
        env:
          GITHUB_TOKEN: ${{ secrets.MY_GH_PAT }}
        run: |
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$OWNER/$REPO/contributors?per_page=1")
          echo "Contributors API HTTP status = $STATUS"
          if [ "$STATUS" = "404" ]; then
            echo "::warning::Contributors API returns 404 (private repo without permission OR repo not found by token). The action may fail for the same reason."
          fi
      
      - name: Update contributors in both READMEs
        uses: akhilmhdh/contributors-readme-action@v2.3.10
        env:
          GITHUB_TOKEN: ${{ secrets.MY_GH_PAT }}
        with:
          # ✅ 支持多个 README，用逗号分隔
          readme_path: "README.md, README_zh.md"
          columns_per_row: 12
          image_size: 80
          commit_message: "docs: update contributors [skip ci]"
          auto_detect_branch_protection: false
