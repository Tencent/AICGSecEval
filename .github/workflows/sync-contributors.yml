name: Update Contributors in README

on:
  workflow_dispatch:
    inputs:
      comment:
        description: 'æ‰‹åŠ¨è§¦å‘å¤‡æ³¨'
        required: false
        default: 'Update contributors list'

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Install dependencies (jq + perl)
        run: sudo apt-get update && sudo apt-get install -y jq perl

      # å…³é”®ä¿®å¤ï¼šä¼˜åŒ–curlæ ¡éªŒ+å…¼å®¹æ–‡ä»¶å¤§å°æ£€æµ‹+é”™è¯¯æ•è·
      - name: Generate contributors HTML (fixed compatibility)
        id: gen_contrib
        run: |
          set -euo pipefail # å¼€å¯ä¸¥æ ¼æ¨¡å¼ï¼Œæ•è·æ‰€æœ‰é”™è¯¯
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          API_URL="https://api.github.com/repos/$OWNER/$REPO/contributors?per_page=100"
          
          echo "ğŸ” Fetching from $API_URL"
          # curl å¢å¼ºï¼šè·å–HTTPçŠ¶æ€ç +è¾“å‡ºå“åº”ä½“ï¼Œæ ¡éªŒ200çŠ¶æ€
          RESPONSE=$(curl -s -w "%{http_code}" -H "Authorization: Bearer ${{ github.token }}" "$API_URL")
          HTTP_CODE=$(echo "$RESPONSE" | tail -c 4) # æå–æœ€å4ä¸ªå­—ç¬¦ï¼ˆçŠ¶æ€ç ï¼‰
          CONTRIBUTORS=$(echo "$RESPONSE" | head -c -4) # æå–å“åº”ä½“ï¼ˆæ’é™¤çŠ¶æ€ç ï¼‰
          
          # æ ¡éªŒHTTPçŠ¶æ€ç 
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âŒ API request failed (HTTP $HTTP_CODE)"
            echo "Response: $CONTRIBUTORS"
            exit 1
          fi
          
          # æ ¡éªŒå“åº”ä½“æ˜¯å¦ä¸ºæœ‰æ•ˆJSON
          if ! echo "$CONTRIBUTORS" | jq . > /dev/null 2>&1; then
            echo "âŒ Invalid JSON response from API"
            exit 1
          fi
          
          # ç”ŸæˆHTMLå¹¶å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼ˆå…¼å®¹å†™æ³•ï¼‰
          echo "$CONTRIBUTORS" | jq -r '
            .[] | 
            "<a href=\"\(.html_url)\" target=\"_blank\" rel=\"noopener noreferrer\" title=\"\(.login)\">" +
            "<img src=\"\(.avatar_url)\" alt=\"\(.login)\" width=\"48\" height=\"48\" style=\"border-radius: 50%; margin: 0 8px 8px 0; object-fit: cover;\" />" +
            "</a>"
          ' | tr -d '\n' > /tmp/contributors.html
          
          # å…¼å®¹æ–¹å¼è·å–æ–‡ä»¶å¤§å°ï¼ˆæ›¿æ¢statï¼Œé¿å…ç¯å¢ƒå·®å¼‚ï¼‰
          HTML_SIZE=$(wc -c < /tmp/contributors.html)
          echo "ğŸ“ HTML file size: $HTML_SIZE bytes"
          
          # æ ¡éªŒHTMLéç©º
          if [ "$HTML_SIZE" -lt 100 ]; then
            echo "âŒ HTML content is too small (likely invalid)"
            cat /tmp/contributors.html # è¾“å‡ºå†…å®¹è°ƒè¯•
            exit 1
          fi
          
          echo "âœ… Contributors HTML generated successfully"

      # ä¿æŒperlæ›¿æ¢é€»è¾‘ï¼ˆå·²éªŒè¯æœ‰æ•ˆï¼‰
      - name: Update README files (perl replacement)
        id: update_files
        run: |
          update_readme() {
            local file="$1"
            local start="<!-- readme: contributors -start -->"
            local end="<!-- readme: contributors -end -->"
            
            [ ! -f "$file" ] && echo "âš ï¸ $file not found" && return 1
            if ! grep -qF "$start" "$file" || ! grep -qF "$end" "$file"; then
              echo "âŒ $file missing tags (start/end)"
              grep -nF "$start\|$end" "$file" || echo "   Tags not found"
              return 1
            fi
            
            # Perlå¤šè¡Œæ›¿æ¢ï¼ˆç¨³å®šå¤„ç†é•¿å­—ç¬¦ä¸²ï¼‰
            perl -0777 -i.bak -pe "
              s|$start\n.*?$end|$start\n$(cat /tmp/contributors.html)\n$end|gs
            " "$file"
            rm -f "$file.bak"
            
            # éªŒè¯æ›¿æ¢ç»“æœ
            CONTENT_BETWEEN=$(awk -v s="$start" -v e="$end" '
              $0 == s { flag=1; next }
              $0 == e { flag=0 }
              flag { print }
            ' "$file")
            
            if [ -n "$CONTENT_BETWEEN" ]; then
              echo "âœ… $file updated (preview: ${CONTENT_BETWEEN:0:80}...)"
              return 0
            else
              echo "âŒ $file update failed: no content between tags"
              return 1
            fi
          }
          
          if update_readme "README.md" && update_readme "README_zh.md"; then
            echo "update_success=true" >> "$GITHUB_ENV"
          else
            echo "update_success=false" >> "$GITHUB_ENV"
          fi

      - name: Commit changes
        if: env.update_success == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: update contributors list"
          file_pattern: "README.md README_zh.md"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"

      - name: Final result
        run: |
          if [ "${{ env.update_success }}" == "true" ]; then
            echo "ğŸ‰ è´¡çŒ®è€…åˆ—è¡¨æ›´æ–°æˆåŠŸï¼"
          else
            echo "âŒ æ›´æ–°å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—è¯¦æƒ…"
            exit 1
          fi
